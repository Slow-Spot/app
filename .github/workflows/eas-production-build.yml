name: üöÄ EAS Production Build & Submit

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_run:
    workflows: ["Semantic Release"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android
      submit:
        description: 'Auto-submit to stores'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  prepare:
    name: üìã Prepare Release
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_notes: ${{ steps.notes.outputs.notes }}
      should_submit: ${{ steps.check.outputs.submit }}
      should_build: ${{ steps.release_check.outputs.should_build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0

      - name: Check if new release exists
        id: release_check
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_run" ]]; then
            VERSION=$(cat mobile/package.json | jq -r '.version')
            TAG_EXISTS=$(git tag -l "v$VERSION")
            if [[ -n "$TAG_EXISTS" ]]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "üì¶ New release v$VERSION detected, triggering build"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è No new release tag v$VERSION found, skipping build"
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: version
        if: steps.release_check.outputs.should_build == 'true'
        env:
          GIT_REF: ${{ github.ref }}
        run: |
          if [[ "$GIT_REF" == refs/tags/* ]]; then
            VERSION="${GIT_REF#refs/tags/v}"
          else
            VERSION=$(cat mobile/package.json | jq -r '.version')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      - name: Get release notes
        id: notes
        if: steps.release_check.outputs.should_build == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          NOTES=$(gh release view "v${RELEASE_VERSION}" --json body -q '.body' 2>/dev/null || echo "Bug fixes and improvements")
          NOTES=$(echo "$NOTES" | head -c 450)
          NOTES=$(echo "$NOTES" | jq -Rs .)
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Check if should submit
        id: check
        if: steps.release_check.outputs.should_build == 'true'
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_SUBMIT: ${{ github.event.inputs.submit }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "submit=$INPUT_SUBMIT" >> $GITHUB_OUTPUT
          else
            echo "submit=true" >> $GITHUB_OUTPUT
          fi

  build-ios:
    name: üçé Build iOS
    needs: prepare
    runs-on: ubuntu-latest
    if: |
      needs.prepare.outputs.should_build == 'true' && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_run' ||
        github.event.inputs.platform == 'ios' ||
        github.event.inputs.platform == 'all'
      )
    defaults:
      run:
        working-directory: ./mobile

    outputs:
      build_id: ${{ steps.build.outputs.build_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build iOS
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform ios --profile production --non-interactive --json)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "üçé iOS Build ID: $BUILD_ID"

      - name: Setup App Store Connect API Key
        if: needs.prepare.outputs.should_submit == 'true'
        env:
          ASC_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          echo "$ASC_API_KEY_BASE64" | base64 -d > AuthKey_W3TGVKY5Z6.p8
          echo "‚úÖ App Store Connect API Key configured"

      - name: Submit to App Store
        if: needs.prepare.outputs.should_submit == 'true'
        env:
          ASC_API_KEY_PATH: ${{ github.workspace }}/mobile/AuthKey_W3TGVKY5Z6.p8
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_KEY_ISSUER_ID: ${{ secrets.ASC_API_KEY_ISSUER_ID }}
        run: |
          echo "üì§ Submitting iOS to App Store..."
          eas submit --platform ios --profile production --non-interactive --latest

      - name: Cleanup iOS credentials
        if: always()
        run: rm -f AuthKey_W3TGVKY5Z6.p8

  build-android:
    name: ü§ñ Build Android
    needs: prepare
    runs-on: ubuntu-latest
    if: |
      needs.prepare.outputs.should_build == 'true' && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_run' ||
        github.event.inputs.platform == 'android' ||
        github.event.inputs.platform == 'all'
      )
    defaults:
      run:
        working-directory: ./mobile

    outputs:
      build_id: ${{ steps.build.outputs.build_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build Android
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --json)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ü§ñ Android Build ID: $BUILD_ID"

      - name: Setup Google Play Service Account
        if: needs.prepare.outputs.should_submit == 'true'
        env:
          GPLAY_SA_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GPLAY_SA_JSON" > android-service-account.json
          echo "‚úÖ Google Play Service Account configured"

      - name: Submit to Google Play
        if: needs.prepare.outputs.should_submit == 'true'
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY_PATH: ${{ github.workspace }}/mobile/android-service-account.json
        run: |
          echo "üì§ Submitting Android to Google Play..."
          eas submit --platform android --profile production --non-interactive --latest

      - name: Cleanup Android credentials
        if: always()
        run: rm -f android-service-account.json

  summary:
    name: üìä Build Summary
    needs: [prepare, build-ios, build-android]
    runs-on: ubuntu-latest
    if: always() && needs.prepare.outputs.should_build == 'true'

    steps:
      - name: Generate Summary
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          SHOULD_SUBMIT: ${{ needs.prepare.outputs.should_submit }}
          IOS_RESULT: ${{ needs.build-ios.result }}
          IOS_BUILD_ID: ${{ needs.build-ios.outputs.build_id }}
          ANDROID_RESULT: ${{ needs.build-android.result }}
          ANDROID_BUILD_ID: ${{ needs.build-android.outputs.build_id }}
        run: |
          echo "## üöÄ Production Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Submit:** ${SHOULD_SUBMIT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Build ID |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üçé iOS | ${IOS_RESULT} | ${IOS_BUILD_ID:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| ü§ñ Android | ${ANDROID_RESULT} | ${ANDROID_BUILD_ID:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [EAS Builds](https://expo.dev/accounts/leszekszpunar/projects/slow-spot/builds)" >> $GITHUB_STEP_SUMMARY
          echo "- [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY

  notify-release:
    name: üì¢ Update GitHub Release
    needs: [prepare, build-ios, build-android]
    runs-on: ubuntu-latest
    if: |
      needs.prepare.outputs.should_build == 'true' && (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
        github.event_name == 'workflow_run'
      )

    steps:
      - name: Update Release with Build Info
        uses: actions/github-script@v7
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
          IOS_RESULT: ${{ needs.build-ios.result }}
          ANDROID_RESULT: ${{ needs.build-android.result }}
          SHOULD_SUBMIT: ${{ needs.prepare.outputs.should_submit }}
        with:
          script: |
            const tag = `v${process.env.RELEASE_VERSION}`;

            let release;
            try {
              release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
            } catch (e) {
              console.log(`No release found for tag ${tag}, skipping update`);
              return;
            }

            const buildInfo = `

            ---

            ## üì± Build Status

            | Platform | Status |
            |----------|--------|
            | üçé iOS | ${process.env.IOS_RESULT} |
            | ü§ñ Android | ${process.env.ANDROID_RESULT} |

            **Auto-submitted to stores:** ${process.env.SHOULD_SUBMIT}

            [View builds on Expo](https://expo.dev/accounts/leszekszpunar/projects/slow-spot/builds)
            `;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              body: release.data.body + buildInfo
            });
