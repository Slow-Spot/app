name: Cleanup Old Builds

on:
  # Run automatically after each successful build
  workflow_run:
    workflows: ["EAS Preview Build (Test Deployment)", "EAS Production Build", "EAS Update (OTA - Expo Go)"]
    types:
      - completed

  # Run weekly to clean up old builds
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight

  # Manual trigger
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of recent workflow runs to keep'
        required: true
        default: '5'
        type: string

jobs:
  cleanup:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          KEEP_COUNT: ${{ github.event.inputs.keep_count || '5' }}
        run: |
          echo "Cleaning up old workflow runs..."
          echo "Keeping the ${KEEP_COUNT} most recent runs for each workflow"

          # Get all workflows
          workflows=$(gh api repos/${REPO}/actions/workflows --jq '.workflows[] | .id')

          for workflow_id in $workflows; do
            workflow_name=$(gh api repos/${REPO}/actions/workflows/${workflow_id} --jq '.name')
            echo ""
            echo "Processing workflow: ${workflow_name}"

            # Get all runs for this workflow, sorted by creation date (newest first)
            run_ids=$(gh api \
              "repos/${REPO}/actions/workflows/${workflow_id}/runs" \
              --paginate \
              --jq '.workflow_runs | sort_by(.created_at) | reverse | .[].id')

            # Count total runs
            total=$(echo "$run_ids" | wc -l | xargs)
            echo "   Total runs: ${total}"

            # Skip the first KEEP_COUNT runs (most recent)
            to_delete=$(echo "$run_ids" | tail -n +$((KEEP_COUNT + 1)))
            delete_count=$(echo "$to_delete" | grep -c . || echo 0)

            if [ "$delete_count" -gt 0 ]; then
              echo "   Deleting ${delete_count} old runs..."

              # Delete each old run
              echo "$to_delete" | while read -r run_id; do
                if [ -n "$run_id" ]; then
                  gh api \
                    --method DELETE \
                    "repos/${REPO}/actions/runs/${run_id}" \
                    2>/dev/null && echo "      [OK] Deleted run ${run_id}" || echo "      [FAIL] Failed to delete run ${run_id}"
                fi
              done
            else
              echo "   No runs to delete (${total} runs, keeping ${KEEP_COUNT})"
            fi
          done

          echo ""
          echo "Cleanup complete!"

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "Cleaning up artifacts older than 7 days..."

          # Get all artifacts
          artifacts=$(gh api repos/${REPO}/actions/artifacts --paginate --jq '.artifacts[] | select(.created_at < (now - 7*24*60*60 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' 2>/dev/null || echo "")

          if [ -z "$artifacts" ]; then
            echo "No old artifacts to delete"
          else
            count=$(echo "$artifacts" | wc -l | xargs)
            echo "Found ${count} artifacts to delete"

            echo "$artifacts" | while read -r artifact_id; do
              if [ -n "$artifact_id" ]; then
                gh api --method DELETE "repos/${REPO}/actions/artifacts/${artifact_id}" 2>/dev/null \
                  && echo "   [OK] Deleted artifact ${artifact_id}" \
                  || echo "   [FAIL] Failed to delete artifact ${artifact_id}"
              fi
            done
          fi

          echo "Artifact cleanup complete!"

  cleanup-cache:
    name: Cleanup Old Cache
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old cache entries
        run: |
          echo "Cleaning up old cache entries..."
          # GitHub automatically removes cache entries older than 7 days
          # or when total cache size exceeds 10GB
          # This step serves as documentation
          echo "Cache cleanup is handled automatically by GitHub"
          echo "   - Removes entries older than 7 days"
          echo "   - Maintains max 10GB total cache size"
