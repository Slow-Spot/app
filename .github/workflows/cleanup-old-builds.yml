name: üßπ Cleanup Old Builds & Branches

on:
  # Run automatically after each successful build
  workflow_run:
    workflows:
      - "üß™ EAS Preview Build (RC & Beta Testing)"
      - "üöÄ EAS Production Build & Submit"
      - "üì± EAS Update (OTA)"
      - "Semantic Release"
    types:
      - completed

  # Run daily to clean up old builds and stale branches
  schedule:
    - cron: '0 2 * * *' # Every day at 2 AM UTC

  # Manual trigger
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of recent workflow runs to keep per workflow'
        required: true
        default: '5'
        type: string
      stale_branch_days:
        description: 'Delete branches with no commits for X days (0 = skip)'
        required: true
        default: '30'
        type: string
      dry_run:
        description: 'Dry run (show what would be deleted without deleting)'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          KEEP_COUNT: ${{ github.event.inputs.keep_count || '5' }}
        run: |
          echo "Cleaning up old workflow runs..."
          echo "Keeping the ${KEEP_COUNT} most recent runs for each workflow"

          # Get all workflows
          workflows=$(gh api repos/${REPO}/actions/workflows --jq '.workflows[] | .id')

          for workflow_id in $workflows; do
            workflow_name=$(gh api repos/${REPO}/actions/workflows/${workflow_id} --jq '.name')
            echo ""
            echo "Processing workflow: ${workflow_name}"

            # Get all runs for this workflow, sorted by creation date (newest first)
            run_ids=$(gh api \
              "repos/${REPO}/actions/workflows/${workflow_id}/runs" \
              --paginate \
              --jq '.workflow_runs | sort_by(.created_at) | reverse | .[].id')

            # Count total runs
            total=$(echo "$run_ids" | wc -l | xargs)
            echo "   Total runs: ${total}"

            # Skip the first KEEP_COUNT runs (most recent)
            to_delete=$(echo "$run_ids" | tail -n +$((KEEP_COUNT + 1)))
            delete_count=$(echo "$to_delete" | grep -c . || echo 0)

            if [ "$delete_count" -gt 0 ]; then
              echo "   Deleting ${delete_count} old runs..."

              # Delete each old run
              echo "$to_delete" | while read -r run_id; do
                if [ -n "$run_id" ]; then
                  gh api \
                    --method DELETE \
                    "repos/${REPO}/actions/runs/${run_id}" \
                    2>/dev/null && echo "      [OK] Deleted run ${run_id}" || echo "      [FAIL] Failed to delete run ${run_id}"
                fi
              done
            else
              echo "   No runs to delete (${total} runs, keeping ${KEEP_COUNT})"
            fi
          done

          echo ""
          echo "Cleanup complete!"

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "Cleaning up artifacts older than 7 days..."

          # Get all artifacts
          artifacts=$(gh api repos/${REPO}/actions/artifacts --paginate --jq '.artifacts[] | select(.created_at < (now - 7*24*60*60 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' 2>/dev/null || echo "")

          if [ -z "$artifacts" ]; then
            echo "No old artifacts to delete"
          else
            count=$(echo "$artifacts" | wc -l | xargs)
            echo "Found ${count} artifacts to delete"

            echo "$artifacts" | while read -r artifact_id; do
              if [ -n "$artifact_id" ]; then
                gh api --method DELETE "repos/${REPO}/actions/artifacts/${artifact_id}" 2>/dev/null \
                  && echo "   [OK] Deleted artifact ${artifact_id}" \
                  || echo "   [FAIL] Failed to delete artifact ${artifact_id}"
              fi
            done
          fi

          echo "Artifact cleanup complete!"

  cleanup-cache:
    name: Cleanup Old Cache
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old cache entries
        run: |
          echo "Cleaning up old cache entries..."
          # GitHub automatically removes cache entries older than 7 days
          # or when total cache size exceeds 10GB
          # This step serves as documentation
          echo "Cache cleanup is handled automatically by GitHub"
          echo "   - Removes entries older than 7 days"
          echo "   - Maintains max 10GB total cache size"

  cleanup-stale-branches:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger (not after every build)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete stale branches
        env:
          GH_TOKEN: ${{ github.token }}
          STALE_DAYS: ${{ github.event.inputs.stale_branch_days || '30' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "üßπ Cleaning up stale branches..."
          echo "   Stale threshold: ${STALE_DAYS} days"
          echo "   Dry run: ${DRY_RUN}"
          echo ""

          # Protected branches that should NEVER be deleted
          PROTECTED_BRANCHES="main develop"

          # Branch patterns to check for staleness
          # - feature/* branches older than STALE_DAYS
          # - release/* branches that are merged and older than 7 days
          # - fix/*, hotfix/*, chore/* branches older than STALE_DAYS

          deleted_count=0
          skipped_count=0

          # Get all remote branches
          echo "üìã Fetching branch list..."
          branches=$(git branch -r --format='%(refname:short)' | grep -v 'origin/HEAD' | sed 's|origin/||')

          for branch in $branches; do
            # Skip protected branches
            if echo "$PROTECTED_BRANCHES" | grep -qw "$branch"; then
              echo "üõ°Ô∏è  [PROTECTED] $branch - skipping"
              continue
            fi

            # Get last commit date for the branch
            last_commit_date=$(git log -1 --format='%ci' "origin/$branch" 2>/dev/null || echo "")
            if [ -z "$last_commit_date" ]; then
              echo "‚ö†Ô∏è  [UNKNOWN] $branch - could not get last commit date"
              continue
            fi

            # Calculate days since last commit
            last_commit_ts=$(date -d "$last_commit_date" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S %z" "$last_commit_date" +%s 2>/dev/null)
            current_ts=$(date +%s)
            days_old=$(( (current_ts - last_commit_ts) / 86400 ))

            # Check if branch is stale
            if [ "$days_old" -ge "$STALE_DAYS" ]; then
              # Check if it's a release branch - these get shorter grace period if merged
              if [[ "$branch" == release/* ]]; then
                # Check if release branch is merged to main
                if git branch -r --merged origin/main | grep -q "origin/$branch"; then
                  if [ "$days_old" -ge 7 ]; then
                    if [ "$DRY_RUN" = "true" ]; then
                      echo "üîç [DRY RUN] Would delete merged release branch: $branch (${days_old} days old)"
                    else
                      echo "üóëÔ∏è  [DELETING] Merged release branch: $branch (${days_old} days old)"
                      git push origin --delete "$branch" 2>/dev/null && deleted_count=$((deleted_count + 1)) || echo "      ‚ö†Ô∏è  Failed to delete"
                    fi
                  else
                    echo "‚è≥ [RECENT] $branch - merged but only ${days_old} days old (keeping for 7 days)"
                    skipped_count=$((skipped_count + 1))
                  fi
                else
                  echo "‚è≥ [ACTIVE] $branch - release branch not yet merged (${days_old} days old)"
                  skipped_count=$((skipped_count + 1))
                fi
              else
                # Regular feature/fix/chore branches
                if [ "$DRY_RUN" = "true" ]; then
                  echo "üîç [DRY RUN] Would delete stale branch: $branch (${days_old} days old)"
                else
                  echo "üóëÔ∏è  [DELETING] Stale branch: $branch (${days_old} days old)"
                  git push origin --delete "$branch" 2>/dev/null && deleted_count=$((deleted_count + 1)) || echo "      ‚ö†Ô∏è  Failed to delete"
                fi
              fi
            else
              echo "‚úÖ [ACTIVE] $branch - ${days_old} days old"
              skipped_count=$((skipped_count + 1))
            fi
          done

          echo ""
          echo "üìä Summary:"
          echo "   Deleted: ${deleted_count} branches"
          echo "   Skipped: ${skipped_count} branches"
          echo "   Protected: main, develop (never deleted)"
