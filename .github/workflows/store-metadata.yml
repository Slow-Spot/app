name: ðŸ“ Store Metadata Sync

on:
  push:
    paths:
      - 'mobile/store/**'
      - 'mobile/scripts/generate-android-metadata.js'
      - 'mobile/scripts/generate-ios-metadata.js'
    branches:
      - main
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to sync metadata'
        required: true
        default: 'all'
        type: choice
        options:
          - ios
          - android
          - all
      include_screenshots:
        description: 'Include screenshots and graphics'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  sync-ios-metadata:
    name: ðŸŽ Sync iOS Metadata
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'ios' ||
      github.event.inputs.platform == 'all'
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./mobile/fastlane

      - name: Install Fastlane
        run: |
          cd fastlane
          bundle install

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo '${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}' > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}

      - name: Generate iOS metadata structure
        run: |
          echo "ðŸ“¦ Generating iOS metadata from store/metadata.json..."
          node scripts/generate-ios-metadata.js

      - name: Push iOS Metadata to App Store Connect
        run: |
          echo "ðŸ“ Syncing iOS metadata to App Store Connect..."
          INCLUDE_SCREENSHOTS="${{ github.event.inputs.include_screenshots || 'true' }}"

          if [ "$INCLUDE_SCREENSHOTS" == "true" ]; then
            echo "Including screenshots..."
            cd fastlane && bundle exec fastlane ios upload_metadata
          else
            echo "Skipping screenshots (text metadata only)..."
            cd fastlane && bundle exec fastlane ios upload_text_metadata
          fi
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        continue-on-error: true

      - name: Cleanup API Key
        if: always()
        run: rm -rf ~/.appstoreconnect

      - name: Summary
        run: |
          echo "## ðŸŽ iOS Metadata Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Metadata has been pushed to App Store Connect via Fastlane deliver." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source files:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`store/metadata.json\` - Localized content" >> $GITHUB_STEP_SUMMARY
          echo "- \`store/screenshots/ios/\` - Screenshots by locale/device" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated structure:**" >> $GITHUB_STEP_SUMMARY
          echo "\`fastlane/metadata/\` and \`fastlane/screenshots/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View in App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY

  sync-android-metadata:
    name: ðŸ¤– Sync Android Metadata
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'android' ||
      github.event.inputs.platform == 'all'
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./mobile/fastlane

      - name: Install Fastlane
        run: |
          cd fastlane
          bundle install

      - name: Patch Fastlane bugs #21530 and #21007
        run: |
          # Find and patch the uploader.rb file to fix nil releases bugs
          UPLOADER_FILE=$(find fastlane/vendor -name "uploader.rb" -path "*/supply/lib/supply/*" 2>/dev/null | head -1)
          if [ -n "$UPLOADER_FILE" ]; then
            echo "Patching: $UPLOADER_FILE"

            # Bug #21530: Replace 'if releases.size > 1' with nil-safe version
            sed -i 's/if releases\.size > 1/if releases\&\.size\.to_i > 1/g' "$UPLOADER_FILE"

            # Bug #21530: Replace 'releases.first' with nil-safe version
            sed -i 's/releases\.first$/releases\&\.first/g' "$UPLOADER_FILE"

            # Bug #21007: Change the "Could not find release" error to a warning
            # This allows metadata upload without active releases when skip_upload_changelogs=true
            sed -i "s/UI.user_error!(\"Could not find release for version code/UI.important(\"No release found for version code/g" "$UPLOADER_FILE"

            # Also skip the changelog upload if release is nil
            sed -i 's/upload_changelogs(release_notes, release, track, track_name) unless release_notes.empty?/upload_changelogs(release_notes, release, track, track_name) unless release_notes.empty? || release.nil?/g' "$UPLOADER_FILE"

            echo "Patches applied successfully"
            grep -n "release" "$UPLOADER_FILE" | grep -E "(user_error|important|upload_changelog)" | head -10
          else
            echo "Warning: Could not find uploader.rb to patch"
          fi

      - name: Setup Google Play credentials
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android-service-account.json
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}

      - name: Generate Fastlane metadata structure
        run: |
          echo "ðŸ“¦ Generating metadata from store/metadata.json..."
          node scripts/generate-android-metadata.js

      - name: Push Android Metadata to Google Play
        run: |
          echo "ðŸ“ Syncing Android metadata to Google Play..."
          INCLUDE_SCREENSHOTS="${{ github.event.inputs.include_screenshots || 'true' }}"

          if [ "$INCLUDE_SCREENSHOTS" == "true" ]; then
            echo "Including screenshots and graphics..."
            cd fastlane && bundle exec fastlane android full_sync
          else
            echo "Skipping screenshots (text metadata only)..."
            cd fastlane && bundle exec fastlane android upload_text_metadata
          fi
        env:
          GOOGLE_PLAY_JSON_KEY_FILE: ${{ github.workspace }}/mobile/android-service-account.json
        continue-on-error: true

      - name: Cleanup credentials
        if: always()
        run: rm -f android-service-account.json

      - name: Summary
        run: |
          echo "## ðŸ¤– Android Metadata Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Metadata has been pushed to Google Play Console." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source files:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`store/metadata.json\` - Localized content" >> $GITHUB_STEP_SUMMARY
          echo "- \`store/screenshots/android/\` - Screenshots by locale" >> $GITHUB_STEP_SUMMARY
          echo "- \`store/graphics/android/\` - Feature graphic & icon" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated structure:**" >> $GITHUB_STEP_SUMMARY
          echo "\`fastlane/metadata/android/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View in Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY

  summary:
    name: ðŸ“Š Sync Summary
    needs: [sync-ios-metadata, sync-android-metadata]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“ Store Metadata Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ iOS (App Store Connect) | ${{ needs.sync-ios-metadata.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Android (Google Play) | ${{ needs.sync-android-metadata.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Languages" >> $GITHUB_STEP_SUMMARY
          echo "en-US, pl, de-DE, es-ES, fr-FR, zh-Hans, hi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Store Links" >> $GITHUB_STEP_SUMMARY
          echo "- [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY
