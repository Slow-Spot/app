# Fastfile for Slow Spot
# Handles Google Play metadata sync (screenshots, descriptions, graphics)
# @see https://docs.fastlane.tools/

default_platform(:android)

platform :android do

  # ============================================
  # METADATA MANAGEMENT
  # ============================================

  desc "Upload all metadata to Google Play (descriptions, screenshots, graphics)"
  lane :upload_metadata do
    # Generate metadata from our central JSON file
    sh("cd .. && node scripts/generate-android-metadata.js")

    # Upload metadata to Google Play
    # Note: skip_upload_changelogs=true because changelogs require an active release
    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true,
      validate_only: false
    )

    UI.success("Metadata uploaded successfully to Google Play!")
  end

  desc "Validate metadata without uploading"
  lane :validate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      validate_only: true
    )

    UI.success("Metadata validation passed!")
  end

  desc "Upload only screenshots (no text metadata)"
  lane :upload_screenshots do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Screenshots uploaded successfully!")
  end

  desc "Upload only text metadata (no screenshots)"
  lane :upload_text_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true
    )

    UI.success("Text metadata uploaded successfully!")
  end

  # ============================================
  # LEGACY LANE (backward compatibility)
  # ============================================

  desc "Sync metadata to Google Play Console (alias for upload_metadata)"
  lane :sync_metadata do
    upload_metadata
  end

  # ============================================
  # CHANGELOGS (requires active release)
  # ============================================

  desc "Update release notes/changelog only (requires active release on track)"
  lane :update_changelog do |options|
    version_code = options[:version_code] || ENV["VERSION_CODE"]

    unless version_code
      UI.user_error!("version_code is required for changelog upload. Pass it as version_code:12345")
    end

    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false,
      version_code: version_code.to_i
    )

    UI.success("Changelog updated for version #{version_code}!")
  end

  # ============================================
  # FULL SYNC
  # ============================================

  desc "Full sync - upload everything (metadata, screenshots, graphics)"
  lane :full_sync do
    UI.message("Starting full metadata sync...")

    sh("cd .. && node scripts/generate-android-metadata.js")

    # Step 1: Upload images/screenshots first (doesn't require releases)
    UI.message("Uploading images and screenshots...")
    begin
      upload_to_play_store(
        package_name: "com.slowspot.app",
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,  # Skip text to avoid releases bug
        skip_upload_images: false,
        skip_upload_screenshots: false,
        skip_upload_changelogs: true,
        sync_image_upload: true
      )
      UI.success("Images and screenshots uploaded!")
    rescue => e
      UI.important("Images upload had issues: #{e.message}")
    end

    # Step 2: Try to upload text metadata
    # Note: This may fail if there are no editable releases (Fastlane bug #21530)
    UI.message("Uploading text metadata...")
    begin
      upload_to_play_store(
        package_name: "com.slowspot.app",
        track: "production",
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: false,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true
      )
      UI.success("Text metadata uploaded!")
    rescue => e
      UI.important("Text metadata upload failed: #{e.message}")
      UI.important("This is likely due to Fastlane bug #21530 (no editable releases)")
      UI.important("Text metadata can be updated manually in Google Play Console")
    end

    UI.success("Full sync completed!")
  end

  # ============================================
  # DOWNLOAD / UTILITIES
  # ============================================

  desc "Download current metadata from Google Play (for backup/comparison)"
  lane :download_metadata do
    download_from_play_store(
      package_name: "com.slowspot.app"
    )

    UI.success("Metadata downloaded to fastlane/metadata/android/")
  end

  desc "Generate metadata files locally (without uploading)"
  lane :generate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")
    UI.success("Metadata generated in fastlane/metadata/android/")
  end

  desc "Check connection to Google Play"
  lane :check_connection do
    validate_play_store_json_key
    UI.success("Google Play connection successful!")
  end

end

platform :ios do
  desc "Note: iOS metadata is handled by EAS Metadata"
  lane :info do
    UI.message("iOS metadata is managed via EAS Metadata (store.config.js)")
    UI.message("Run: cd mobile && eas metadata:push --platform ios")
  end
end
