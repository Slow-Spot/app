# Fastfile for Slow Spot
# Handles Google Play metadata sync (screenshots, descriptions, graphics)
# @see https://docs.fastlane.tools/

# ============================================
# MONKEY PATCH: Fix Fastlane bug #21530
# When production track has no editable releases, releases is nil
# This patch adds nil-safety to prevent crashes
# ============================================
require 'supply'

module Supply
  class Uploader
    # Override fetch_track_and_release! with nil-safety
    def fetch_track_and_release!(track:)
      track_response = client.tracks(track)
      releases = track_response.releases

      # FIX: Handle nil releases gracefully
      if releases.nil? || releases.empty?
        UI.important("No editable releases found on '#{track}' track - continuing without release info")
        return nil
      end

      if releases.size > 1
        UI.important("More than 1 release found on '#{track}' track - using first one")
      end

      releases.first
    rescue => e
      UI.important("Could not fetch releases: #{e.message}")
      nil
    end
  end
end

default_platform(:android)

platform :android do

  # ============================================
  # METADATA MANAGEMENT
  # ============================================

  desc "Upload all metadata to Google Play (descriptions, screenshots, graphics)"
  lane :upload_metadata do
    # Generate metadata from our central JSON file
    sh("cd .. && node scripts/generate-android-metadata.js")

    # Upload metadata to Google Play
    # Note: No track specified - metadata is app-level, not track-specific
    upload_to_play_store(
      package_name: "com.slowspot.app",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Metadata uploaded successfully to Google Play!")
  end

  desc "Validate metadata without uploading"
  lane :validate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      validate_only: true
    )

    UI.success("Metadata validation passed!")
  end

  desc "Upload only screenshots (no text metadata)"
  lane :upload_screenshots do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Screenshots uploaded successfully!")
  end

  desc "Upload only text metadata (no screenshots)"
  lane :upload_text_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true
    )

    UI.success("Text metadata uploaded successfully!")
  end

  # ============================================
  # LEGACY LANE (backward compatibility)
  # ============================================

  desc "Sync metadata to Google Play Console (alias for upload_metadata)"
  lane :sync_metadata do
    upload_metadata
  end

  # ============================================
  # CHANGELOGS (requires active release)
  # ============================================

  desc "Update release notes/changelog only (requires active release on track)"
  lane :update_changelog do |options|
    version_code = options[:version_code] || ENV["VERSION_CODE"]

    unless version_code
      UI.user_error!("version_code is required for changelog upload. Pass it as version_code:12345")
    end

    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false,
      version_code: version_code.to_i
    )

    UI.success("Changelog updated for version #{version_code}!")
  end

  # ============================================
  # FULL SYNC
  # ============================================

  desc "Full sync - upload everything (metadata, screenshots, graphics)"
  lane :full_sync do
    UI.message("Starting full metadata sync...")

    sh("cd .. && node scripts/generate-android-metadata.js")

    # Upload all metadata to Google Play
    # Note: We don't specify track for metadata-only uploads (no APK/AAB)
    # This avoids Fastlane bug #21007 where skip_upload_changelogs still checks for releases
    upload_to_play_store(
      package_name: "com.slowspot.app",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Full sync completed!")
  end

  # ============================================
  # DOWNLOAD / UTILITIES
  # ============================================

  desc "Download current metadata from Google Play (for backup/comparison)"
  lane :download_metadata do
    download_from_play_store(
      package_name: "com.slowspot.app"
    )

    UI.success("Metadata downloaded to fastlane/metadata/android/")
  end

  desc "Generate metadata files locally (without uploading)"
  lane :generate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")
    UI.success("Metadata generated in fastlane/metadata/android/")
  end

  desc "Check connection to Google Play"
  lane :check_connection do
    validate_play_store_json_key
    UI.success("Google Play connection successful!")
  end

end

platform :ios do
  desc "Note: iOS metadata is handled by EAS Metadata"
  lane :info do
    UI.message("iOS metadata is managed via EAS Metadata (store.config.js)")
    UI.message("Run: cd mobile && eas metadata:push --platform ios")
  end
end
