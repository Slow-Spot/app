# Fastfile for Slow Spot
# Handles Google Play metadata sync (screenshots, descriptions, graphics)
# @see https://docs.fastlane.tools/

# ============================================
# MONKEY PATCH: Fix Fastlane bug #21530
# When production track has no editable releases, releases is nil
# This patch adds nil-safety to prevent crashes
# ============================================
require 'supply'

module Supply
  class Uploader
    # Override fetch_track_and_release! with nil-safety
    def fetch_track_and_release!(track:)
      track_response = client.tracks(track)
      releases = track_response.releases

      # FIX: Handle nil releases gracefully
      if releases.nil? || releases.empty?
        UI.important("No editable releases found on '#{track}' track - continuing without release info")
        return nil
      end

      if releases.size > 1
        UI.important("More than 1 release found on '#{track}' track - using first one")
      end

      releases.first
    rescue => e
      UI.important("Could not fetch releases: #{e.message}")
      nil
    end
  end
end

# NOTE: iPad Pro 13" (M4) support added directly to gem files:
# - vendor/bundle/ruby/2.6.0/gems/fastlane-2.230.0/spaceship/.../app_screenshot_set.rb
# - vendor/bundle/ruby/2.6.0/gems/fastlane-2.230.0/deliver/.../app_screenshot.rb

default_platform(:android)

# Helper to get absolute path for Android metadata
def android_metadata_path
  File.expand_path(File.join(__dir__, "metadata", "android"))
end

platform :android do

  # ============================================
  # METADATA MANAGEMENT
  # ============================================

  desc "Upload all metadata to Google Play (descriptions, screenshots, graphics)"
  lane :upload_metadata do
    # Generate metadata from our central JSON file
    sh("cd .. && node scripts/generate-android-metadata.js")

    # Upload metadata to Google Play
    # Note: No track specified - metadata is app-level, not track-specific
    # For draft apps, we must NOT specify track options to avoid release creation
    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Metadata uploaded successfully to Google Play!")
  end

  desc "Validate metadata without uploading"
  lane :validate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      validate_only: true
    )

    UI.success("Metadata validation passed!")
  end

  desc "Upload only screenshots (no text metadata)"
  lane :upload_screenshots do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Screenshots uploaded successfully!")
  end

  desc "Upload only text metadata (no screenshots)"
  lane :upload_text_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true
    )

    UI.success("Text metadata uploaded successfully!")
  end

  # ============================================
  # LEGACY LANE (backward compatibility)
  # ============================================

  desc "Sync metadata to Google Play Console (alias for upload_metadata)"
  lane :sync_metadata do
    upload_metadata
  end

  # ============================================
  # CHANGELOGS (requires active release)
  # ============================================

  desc "Update release notes/changelog only (requires active release on track)"
  lane :update_changelog do |options|
    version_code = options[:version_code] || ENV["VERSION_CODE"]

    unless version_code
      UI.user_error!("version_code is required for changelog upload. Pass it as version_code:12345")
    end

    sh("cd .. && node scripts/generate-android-metadata.js")

    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      track: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false,
      version_code: version_code.to_i
    )

    UI.success("Changelog updated for version #{version_code}!")
  end

  # ============================================
  # FULL SYNC
  # ============================================

  desc "Full sync - upload everything (metadata, screenshots, graphics)"
  lane :full_sync do
    UI.message("Starting full metadata sync...")

    sh("cd .. && node scripts/generate-android-metadata.js")

    # Upload all metadata to Google Play
    # Note: We don't specify track for metadata-only uploads (no APK/AAB)
    # This avoids Fastlane bug #21007 where skip_upload_changelogs still checks for releases
    upload_to_play_store(
      package_name: "com.slowspot.app",
      metadata_path: android_metadata_path,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: true,
      sync_image_upload: true
    )

    UI.success("Full sync completed!")
  end

  # ============================================
  # DOWNLOAD / UTILITIES
  # ============================================

  desc "Download current metadata from Google Play (for backup/comparison)"
  lane :download_metadata do
    download_from_play_store(
      package_name: "com.slowspot.app"
    )

    UI.success("Metadata downloaded to fastlane/metadata/android/")
  end

  desc "Generate metadata files locally (without uploading)"
  lane :generate_metadata do
    sh("cd .. && node scripts/generate-android-metadata.js")
    UI.success("Metadata generated in fastlane/metadata/android/")
  end

  desc "Check connection to Google Play"
  lane :check_connection do
    validate_play_store_json_key
    UI.success("Google Play connection successful!")
  end

end

platform :ios do

  # ============================================
  # HELPER: App Store Connect API Key
  # ============================================

  # Configure API key authentication
  # Key file location: ~/.appstoreconnect/private_keys/AuthKey_{KEY_ID}.p8
  # Or set APP_STORE_CONNECT_API_KEY_CONTENT env var for CI
  def get_api_key
    key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    issuer_id = ENV["APP_STORE_CONNECT_API_ISSUER_ID"]

    return nil unless key_id && issuer_id

    # Try to read from file first (local development)
    key_filepath = File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{key_id}.p8")

    if File.exist?(key_filepath)
      return app_store_connect_api_key(
        key_id: key_id,
        issuer_id: issuer_id,
        key_filepath: key_filepath,
        in_house: false
      )
    elsif ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
      # Fall back to env var content (CI)
      return app_store_connect_api_key(
        key_id: key_id,
        issuer_id: issuer_id,
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        is_key_content_base64: false,
        in_house: false
      )
    end

    nil
  end

  # ============================================
  # METADATA MANAGEMENT
  # ============================================

  desc "Upload all metadata to App Store Connect (descriptions, keywords, screenshots)"
  lane :upload_metadata do
    # Generate metadata from our central JSON file
    sh("cd .. && node scripts/generate-ios-metadata.js")

    api_key = get_api_key

    # Upload metadata to App Store Connect
    deliver(
      app_identifier: "com.slowspot.app",
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,  # Skip interactive confirmation
      overwrite_screenshots: true,
      precheck_include_in_app_purchases: false,
      metadata_path: "./metadata",
      screenshots_path: "./screenshots"
    )

    UI.success("Metadata uploaded successfully to App Store Connect!")
  end

  desc "Upload only text metadata (no screenshots)"
  lane :upload_text_metadata do
    sh("cd .. && node scripts/generate-ios-metadata.js")

    api_key = get_api_key

    deliver(
      app_identifier: "com.slowspot.app",
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      metadata_path: "./metadata"
    )

    UI.success("Text metadata uploaded successfully!")
  end

  desc "Upload only screenshots"
  lane :upload_screenshots do
    sh("cd .. && node scripts/generate-ios-metadata.js")

    api_key = get_api_key

    deliver(
      app_identifier: "com.slowspot.app",
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      force: true,
      overwrite_screenshots: true,
      precheck_include_in_app_purchases: false,
      screenshots_path: "./screenshots"
    )

    UI.success("Screenshots uploaded successfully!")
  end

  desc "Validate metadata without uploading"
  lane :validate_metadata do
    sh("cd .. && node scripts/generate-ios-metadata.js")

    api_key = get_api_key

    deliver(
      app_identifier: "com.slowspot.app",
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      metadata_path: "./metadata",
      screenshots_path: "./screenshots",
      verify_only: true
    )

    UI.success("Metadata validation passed!")
  end

  # ============================================
  # SUBMIT FOR REVIEW
  # ============================================

  desc "Submit app for App Store review"
  lane :submit_for_review do
    sh("cd .. && node scripts/generate-ios-metadata.js")

    api_key = get_api_key

    deliver(
      app_identifier: "com.slowspot.app",
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,  # Metadata already uploaded
      force: true,
      submit_for_review: true,
      automatic_release: false,
      run_precheck_before_submit: false,  # Skip precheck
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: false,
        export_compliance_encryption_updated: false
      }
    )

    UI.success("App submitted for review!")
  end

  # ============================================
  # FULL SYNC
  # ============================================

  desc "Full sync - upload everything (metadata, screenshots)"
  lane :full_sync do
    UI.message("Starting full iOS metadata sync...")
    upload_metadata
  end

  # ============================================
  # DOWNLOAD / UTILITIES
  # ============================================

  desc "Download current metadata from App Store Connect"
  lane :download_metadata do
    deliver(
      app_identifier: "com.slowspot.app",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      force: true
    )

    UI.success("Metadata downloaded to fastlane/metadata/")
  end

  desc "Generate metadata files locally (without uploading)"
  lane :generate_metadata do
    sh("cd .. && node scripts/generate-ios-metadata.js")
    UI.success("Metadata generated in fastlane/metadata/ and fastlane/screenshots/")
  end

end
